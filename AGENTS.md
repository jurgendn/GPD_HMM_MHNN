# AGENTS.md

Purpose

This document helps automated agents (and maintainers) understand, run, and modify the PHMM example in this repository. It only documents facts observed in the codebase.

Quick start

- Language: Python 3.9+ (README states Python 3.9+). See: README.md:93-99
- Minimal dependencies (observed in README and imports): numpy, scipy, matplotlib. See: README.md:3-6 and exec_model.py imports at exec_model.py:8-11
- Run the demonstration script:
  - Default example (uses data/traffic count.csv):
    ```bash
    python exec_model.py --data "data/traffic count.csv" --m 7 --iter 30
    ```
    (Example taken from README.md:101-104)
  - The CLI arguments are defined in exec_model.py: parse_args() at exec_model.py:220-242. Defaults:
    - --data: data/traffic count.csv
    - --m: 4
    - --iter: 10
    - --train-end: 180
    - --test-start: 181

Primary outputs (written to repository root when exec_model.py runs):
- AIC-BIC.png (plot of information criteria) — created by plot_aic_bic() exec_model.py:166-171
- CDLL.png (log-likelihood trace) — created by plot_cdll() exec_model.py:173-176
- vsdata.png (raw observation series) — created by plot_raw_data() exec_model.py:179-183
- visualized.png (training fit: observed vs predicted) — created by plot_training_prediction() exec_model.py:185-196
- TSC.png (test states vs new observations) — created by plot_test_states() exec_model.py:198-206
- Console output includes AIC/BIC arrays, dwell times, Poisson rates and transition matrix. See exec_model.py end-of-main prints at exec_model.py:262-283

Repository layout (observed files)

- exec_model.py — CLI entry point, autogenerated from a notebook (header: exec_model.py:1-2). Main logic and plotting are here. See functions:
  - load_observation_series(csv_path) — supports a few CSV schemas (exec_model.py:16-86)
  - split_observations(...) — train/test split defaults and slicing (exec_model.py:88-101)
  - phmm(), run_with_m() — wrappers creating PHMMs instances and training with Baum–Welch (exec_model.py:117-130)
  - plotting and reporting helpers (exec_model.py:166-206, 215-206)
  - argument parsing and main() (exec_model.py:220-246, 245-287)

- HMM/PHMMs_fixed.py — primary PHMM implementation (forward/backward, Viterbi, Baum–Welch, AIC/BIC). See class PHMMs beginning at HMM/PHMMs_fixed.py:7. Important methods:
  - __init__(...) expects (init_ditri, init_trans_matrix, set_paramPoisson, ob_seqs, epsi) (HMM/PHMMs_fixed.py:27-42)
  - matrix_alpha(), matrix_beta(), matrix_emission() — forward/backward and emission computations (HMM/PHMMs_fixed.py:48-91)
  - viterbi() — decoding (HMM/PHMMs_fixed.py:98-124)
  - Baum_Welch(max_iter) — training loop, updates transition matrix, Poisson rates, and initial distribution; prints progress (HMM/PHMMs_fixed.py:177-209)
  - AIC(), BIC(), check() for likelihood and IC calculations (HMM/PHMMs_fixed.py:92-96, 210-214)

- HMM/phmm.py, HMM/PHMMs.py, HMM/update.py — earlier / experimental versions mentioned in README.md:87-89. PHMMs_fixed.py is the implementation used by exec_model.py (exec_model.py:12-14 references HMM.PHMMs_fixed)

- data/ — CSV files used as example inputs (multiple formats). Scripts reference data/traffic count.csv by default (exec_model.py:225-226)

Observed CLI & data handling details (implementation facts)

- load_observation_series(csv_path) behavior (exec_model.py:16-86):
  - First attempts to treat the file as a headerless single-column numeric series (reads all non-empty lines and tries to parse the first token of each as a number). If every line can be parsed this way, it returns the numeric array. (exec_model.py:29-49)
  - Otherwise opens with csv.DictReader and looks for either a 'Hourly_Counts' column (returns that column as ints) or a 'Date' column with hourly columns (treats remaining columns as hourly columns and flattens them row-wise). If neither header schema is present, it raises ValueError with observed headers printed (exec_model.py:50-86).
  - This means CSV files with a header but not matching the two expected schemas will fail; headerless numeric lists are accepted if every line parses as numeric.

- split_observations(series, train_end=180, test_start=181) returns train=series[:train_end] and test=series[test_start:] (exec_model.py:88-101). Note the defaults reproduce offsets from the original notebook.

- PHMMs implementation details and gotchas (HMM/PHMMs_fixed.py observations):
  - Computations are done in log-space for numerical stability (see logsumexp usage). Forward/backward return log-alpha/log-beta matrices. Emission matrix computed with logpmf then exponentiated in matrix_emission (HMM/PHMMs_fixed.py:44-90).
  - The constructor expects 5 positional arguments: initial distribution (array), transition matrix (array NxN), Poisson rate vector, observation sequence (1D array), and epsi (float). See HMM/PHMMs_fixed.py:27-42 and how exec_model constructs it in phmm() at exec_model.py:117-123.
  - Baum_Welch prints progress to stdout and updates internal arrays in-place. It uses np.exp on updated log transition matrices before printing (HMM/PHMMs_fixed.py:193-206).
  - In exec_model.phmm(), generate_init(n) is used to create random theta (transition matrix), delta (initial distribution), and lambdas = np.ones(n). Then PHMMs is constructed with delta, theta, lambdas, and the sequence; epsi is 1e-4 (exec_model.py:103-123). generate_init normalizes rows manually (exec_model.py:103-115).
  - Viterbi implementation indexes and the forward/backward shapes should be respected: viterbi() returns a list of states with integer indices in 0..N-1 (HMM/PHMMs_fixed.py:98-124).

Testing & CI

- No test suite or CI configuration detected in repository root. There are no files named like tests/, pytest.ini, tox.ini, or GitHub Actions YAML files in the top two directory levels inspected. Agents should not assume automated tests exist.

Coding style & conventions

- Code is idiomatic Python with some type hints present in exec_model.py (e.g., function annotations, typed tuples/list) (exec_model.py throughout)
- The PHMMs implementation mixes numpy arrays and Python lists; be careful when editing to follow existing patterns for shapes and types (HMM/PHMMs_fixed.py uses lists in intermediate steps then converts to np.array).
- Numerical stability patterns: log-space arithmetic, scipy.stats.poisson.logpmf, and scipy.special.logsumexp are in use. Avoid changing these without rerunning experiments.

Notable repository facts and edits to be cautious about

- exec_model.py is auto-generated from a notebook (exec_model.py:1-2). If you edit exec_model.py and the original notebook still exists (exec_model.ipynb present), keep in mind notebook -> script parity may be broken but there is no automation enforcing sync.
- Default data file name contains a space: "traffic count.csv". Paths and examples in README and exec_model.py use this filename. Be careful with quoting paths when invoking the script. See exec_model.py:225-226 and README.md:103-104.
- PHMMs_fixed.Baum_Welch uses print statements liberally; running the script will produce console output from training. Expect non-deterministic results because initialization is random (README.md:127 and exec_model.py generate_init randomness at exec_model.py:103-115).
- No packaging (no setup.py / pyproject.toml detected). Use a virtual environment and pip install the dependencies listed in README before running.

Where to look for more context (code references)

- README.md — project overview and example run: README.md:86-104, 111-117
- exec_model.py — CLI, CSV parsing, training pipeline, plotting: exec_model.py:16-86, 117-130, 166-206, 220-246, 245-287
- HMM/PHMMs_fixed.py — PHMM implementation (Forward/Backward, Viterbi, Baum–Welch, AIC/BIC): HMM/PHMMs_fixed.py:7-214

Missing / not observed

- No automated tests or linting configuration observed.
- No CI or deployment scripts observed.
- No CONTRIBUTING.md, license file, or CODE_OF_CONDUCT detected at the top level.

Suggested first actions for an agent (observed-feasible)

- Reproduce the demo outputs by running the example command and verify the script completes:
  ```bash
  python exec_model.py --data "data/traffic count.csv" --m 4 --iter 10
  ```
- If modifying PHMMs implementation, run the script after changes to ensure plotting and printed metrics still behave as expected.



